<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>OnTrak - Dashboard</title>
    <style>
        /* Style for the activity progress bar container */
        #activity-progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        /* Style for the activity progress bar */
        #activity-progress-bar {
            height: 20px;
            background-color: #4caf50;
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="container mt-5">
    <h1 class="text-center mb-4">OnTrak - Dashboard</h1>

    <!-- Link to the setup page -->
    <div class="text-center mb-4">
        <a href="{{ url_for('setup') }}" class="btn btn-outline-secondary">Go to Setup</a>
    </div>

    <!-- Form to select the day and update the dashboard accordingly -->
    <div class="text-center mb-4">
        <form method="get" action="{{ url_for('dashboard') }}">
            <label for="day" class="form-label">Select Today:</label>
            <select class="form-select d-inline-block w-auto" id="day" name="day" onchange="this.form.submit()">
                {% for i in range(1, 5) %}
                <option value="Day {{ i }}" {% if selected_day == 'Day ' ~ i %}selected{% endif %}>Day {{ i }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- Add container for displaying current activity details -->
    <div id="current-activity-details" class="text-center mt-4">
        <!-- This will be updated dynamically by JavaScript -->
        No activity in progress
    </div>
    <button id="start-activity" class="btn btn-primary">Start Activity</button>
    <button id="stop-activity" class="btn btn-danger ms-2">Stop Activity</button>
    <button id="skip-activity" class="btn btn-warning ms-2">Skip to Next Activity</button>
    <div id="countdown" class="mt-3"></div>
    <div id="activity-progress-container">
        <div id="activity-progress-bar"></div>
    </div>

    <!-- Display cards for today's progress and upcoming activity -->
    <div class="row mb-4">
        <!-- Card for current activity -->
        <div class="col-md-6 offset-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">Current Activity</div>
                <div class="card-body">
                    <h5 class="card-title text-center">No activity in progress</h5>
                    <p class="card-text text-center"></p>
                </div>
            </div>
        </div>

        <!-- Card for upcoming activity -->
        <div class="col-md-6 offset-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Upcoming Activity</div>
                <div class="card-body">
                    <h5 class="card-title text-center">No upcoming activity</h5>
                    <p class="card-text text-center"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Table overview for all activities of the selected day -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>Activity Overview for {{ selected_day }}</h4>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th class="text-center align-middle">Activity</th>
                                <th class="text-center align-middle">Start Time</th>
                                <th class="text-center align-middle">End Time</th>
                                <th class="text-center align-middle">Duration</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in grouped_activities.get(selected_day, []) %}
                                <tr>
                                    <td class="text-center align-middle">{{ activity[1] }}</td>
                                    <td class="text-center align-middle">{{ activity[4] }}</td>
                                    <td class="text-center align-middle">{{ activity[5] }}</td>
                                    <td class="text-center align-middle">{{ activity[2] }} min</td>
                                    <td>{{ activity[3].replace('\n', '<br>')|safe }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript to handle the activity buttons and progress bar -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/countdown.js') }}"></script>
    <script>
        function updateActivityBoxes(data) {
            console.info("Updating activity boxes with data:", data);
            document.querySelector(".card.text-white.bg-success .card-title").innerText = data.current_activity ? data.current_activity.name : "No activity in progress";
            document.querySelector(".card.text-white.bg-success .card-text").innerText = data.current_activity ? `${data.current_activity.start_time} to ${data.current_activity.end_time}` : "";
            document.querySelector(".card.text-white.bg-warning .card-title").innerText = data.upcoming_activity ? data.upcoming_activity.name : "No upcoming activity";
            document.querySelector(".card.text-white.bg-warning .card-text").innerText = data.upcoming_activity ? `at ${data.upcoming_activity.start_time}` : "";
        }

        document.getElementById("start-activity").addEventListener("click", function() {
            const selectedDay = document.getElementById("day").value;
            if (!selectedDay) {
                alert("Please select a day before starting an activity.");
                console.error("Attempted to start activity without selecting a day.");
                return;
            }
            console.info(`Starting activity for day: ${selectedDay}`);
            fetch("/start_activity", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ day: selectedDay })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error response received: ${response.status} - ${response.statusText}`);
                }
                console.info("Received response for start activity request.");
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    console.error(`Error starting activity: ${data.error}`);
                } else {
                    console.info("Activity data received:", data);
                    document.getElementById("current-activity-details").innerHTML = `Start Time: ${data.start_time}<br>End Time: ${data.end_time}`;
                    document.getElementById("countdown").setAttribute("data-activity-id", data.activity_id);
                    startProgressBar(data.start_time, data.end_time);
                    updateActivityBoxes(data);
                }
            })
            .catch(error => {
                alert("Failed to start activity. Please check the console for more details.");
                console.error("Error in start activity request:", error);
            });
        });

        document.getElementById("stop-activity").addEventListener("click", function() {
            const activityId = document.getElementById("countdown").getAttribute("data-activity-id");
            if (!activityId) {
                alert("No activity in progress to stop.");
                console.error("Attempted to stop activity when no activity was in progress.");
                return;
            }
            console.info(`Stopping activity with ID: ${activityId}`);
            fetch("/stop_activity", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ activity_id: activityId })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error response received: ${response.status} - ${response.statusText}`);
                }
                console.info("Received response for stop activity request.");
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    console.error(`Error stopping activity: ${data.error}`);
                } else {
                    console.info("Activity stopped successfully.");
                    document.getElementById("current-activity-details").innerHTML = "No activity in progress";
                    document.getElementById("countdown").removeAttribute("data-activity-id");
                    updateActivityBoxes({ current_activity: null, upcoming_activity: data.upcoming_activity });
                }
            })
            .catch(error => {
                alert("Failed to stop activity. Please check the console for more details.");
                console.error("Error in stop activity request:", error);
            });
        });

        document.getElementById("skip-activity").addEventListener("click", function() {
            const selectedDay = document.getElementById("day").value;
            if (!selectedDay) {
                alert("Please select a day before skipping an activity.");
                console.error("Attempted to skip activity without selecting a day.");
                return;
            }
            console.info(`Skipping to next activity for day: ${selectedDay}`);
            fetch("/skip_activity", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ day: selectedDay })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error response received: ${response.status} - ${response.statusText}`);
                }
                console.info("Received response for skip activity request.");
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    console.error(`Error skipping activity: ${data.error}`);
                } else {
                    console.info("Activity skipped successfully.");
                    updateActivityBoxes(data);
                }
            })
            .catch(error => {
                alert("Failed to skip activity. Please check the console for more details.");
                console.error("Error in skip activity request:", error);
            });
        });
    </script>
</body>
</html>