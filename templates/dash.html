<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>OnTrak - Dashboard</title>
    <style>
        /* Style for the activity progress bar container */
        #activity-progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        /* Style for the activity progress bar */
        #activity-progress-bar {
            height: 20px;
            background-color: #4caf50;
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="container mt-5">
    <h1 class="text-center mb-4">OnTrak - Dashboard</h1>

    <!-- Link to the setup page -->
    <div class="text-center mb-4">
        <a href="{{ url_for('setup') }}" class="btn btn-outline-secondary">Go to Setup</a>
    </div>

    <!-- Form to select the day and update the dashboard accordingly -->
    <div class="text-center mb-4">
        <form method="get" action="{{ url_for('dashboard') }}">
            <label for="day" class="form-label">Select Today:</label>
            <select class="form-select d-inline-block w-auto" id="day" name="day" onchange="this.form.submit()">
                {% for i in range(1, 5) %}
                <option value="Day {{ i }}" {% if selected_day == 'Day ' ~ i %}selected{% endif %}>Day {{ i }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- Buttons to start and stop activities -->
    <div class="text-center mb-4">
        <button id="start-activity" class="btn btn-primary">Start Activity</button>
        <button id="stop-activity" class="btn btn-danger ms-2">Stop Activity</button>
        <div id="countdown" class="mt-3"></div>
        <div id="activity-progress-container">
            <div id="activity-progress-bar"></div>
        </div>
    </div>

    <!-- Display cards for today's progress, current activity, and upcoming activity -->
    <div class="row mb-4">
        <!-- Card for today's progress -->
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Today's Progress</div>
                <div class="card-body">
                    <h5 class="card-title text-center">Activities Completed</h5>
                    <p class="card-text text-center">{{ completed_activities }} out of {{ grouped_activities[selected_day]|length }} activities completed</p>
                </div>
            </div>
        </div>

        <!-- Card for current activity in progress -->
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-header">Current Activity</div>
                <div class="card-body">
                    <h5 class="card-title text-center">Activity in Progress</h5>
                    <p id="current-activity-details" class="card-text text-center" data-activity-id="">No activity in progress</p>
                </div>
            </div>
        </div>

        <!-- Card for upcoming activity -->
        <div class="col-md-4">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Upcoming Activity</div>
                <div class="card-body">
                    <h5 class="card-title text-center">Next Activity</h5>
                    <p class="card-text text-center">{% if upcoming_activity %}"{{ upcoming_activity[1] }}" at {{ upcoming_activity[4] }}{% else %}No upcoming activity{% endif %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Table overview for all activities of the selected day -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>Activity Overview for {{ selected_day }}</h4>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th class="text-center align-middle">Activity</th>
                                <th class="text-center align-middle">Start Time</th>
                                <th class="text-center align-middle">End Time</th>
                                <th class="text-center align-middle">Duration</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in grouped_activities.get(selected_day, []) %}
                                <tr>
                                    <td class="text-center align-middle">{{ activity[1] }}</td>
                                    <td class="text-center align-middle">{{ activity[4] }}</td>
                                    <td class="text-center align-middle">{{ activity[5] }}</td>
                                    <td class="text-center align-middle">{{ activity[2] }} min</td>
                                    <td>{{ activity[3].replace('\n', '<br>')|safe }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript to handle the activity buttons and progress bar -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/countdown.js') }}"></script>
    <script>
        document.getElementById("start-activity").addEventListener("click", function() {
            const selectedDay = document.getElementById("day").value;
            if (!selectedDay) {
                alert("Please select a day before starting an activity.");
                console.error("Attempted to start activity without selecting a day.");
                return;
            }
            console.info(`Starting activity for day: ${selectedDay}`);
            fetch("/start_activity", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ day: selectedDay })
            })
            .then(response => {
                console.info("Received response for start activity request.");
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    console.error(`Error starting activity: ${data.error}`);
                } else {
                    console.info(`Activity started: ${data.name}, Start Time: ${data.start_time}, End Time: ${data.end_time}`);
                    document.getElementById("current-activity-details").innerText = `${data.name}: ${data.start_time} - ${data.end_time}`;
                    document.getElementById("current-activity-details").setAttribute("data-activity-id", data.activity_id);
                    startProgressBar(data.start_time, data.end_time);
                }
            })
            .catch(error => {
                console.error("Error in start activity request:", error);
            });
        });

        document.getElementById("stop-activity").addEventListener("click", function() {
            const activityId = document.getElementById("current-activity-details").getAttribute("data-activity-id");
            if (!activityId) {
                alert("No activity in progress to stop.");
                console.error("Attempted to stop activity when no activity was in progress.");
                return;
            }
            console.info(`Stopping activity with ID: ${activityId}`);
            fetch("/stop_activity", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ activity_id: activityId })
            })
            .then(response => {
                console.info("Received response for stop activity request.");
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    console.error(`Error stopping activity: ${data.error}`);
                } else {
                    console.info(`Activity stopped with ID: ${activityId}`);
                    document.getElementById("current-activity-details").innerText = "No activity in progress";
                    document.getElementById("current-activity-details").removeAttribute("data-activity-id");
                    stopProgressBar();
                }
            })
            .catch(error => {
                console.error("Error in stop activity request:", error);
            });
        });

        /* Start the progress bar animation for the ongoing activity */
        function startProgressBar(startTime, endTime) {
            const start = new Date();
            const end = new Date();
            const [startHours, startMinutes] = startTime.split(":" ).map(Number);
            const [endHours, endMinutes] = endTime.split(":" ).map(Number);
            start.setHours(startHours, startMinutes, 0, 0);
            end.setHours(endHours, endMinutes, 0, 0);

            console.info(`Starting progress bar from ${startTime} to ${endTime}`);

            function updateProgressBar() {
                const now = new Date().getTime();
                const totalDuration = end - start;
                const elapsed = Math.max(0, now - start.getTime());
                const progress = Math.min(100, (elapsed / totalDuration) * 100);

                document.getElementById("activity-progress-bar").style.width = progress + "%";

                if (now < end.getTime()) {
                    requestAnimationFrame(updateProgressBar);
                } else {
                    console.info("Progress bar completed.");
                }
            }

            updateProgressBar();
        }

        /* Stop the progress bar animation */
        function stopProgressBar() {
            console.info("Stopping progress bar.");
            document.getElementById("activity-progress-bar").style.width = "0%";
        }
    </script>
</body>
</html>