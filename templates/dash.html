<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>OnTrak - Dashboard</title>
    <style>
        /* Style for the activity progress bar */
        #activity-progress-bar {
            height: 20px;
            background-color: #4caf50;
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="container mt-5">
    <h1 class="text-center mb-4">OnTrak - Dashboard</h1>

    <!-- Link to the setup page -->
    <div class="text-center mb-4">
        <a href="{{ url_for('setup') }}" class="btn btn-outline-secondary">Go to Setup</a>
    </div>

    <!-- Form to select the day and update the dashboard accordingly -->
    <div class="text-center mb-4">
        <form method="get" action="{{ url_for('dashboard') }}">
            <label for="day" class="form-label">Select Today:</label>
            <select class="form-select d-inline-block w-auto" id="day" name="day" onchange="this.form.submit()">
                {% for i in range(1, 5) %}
                <option value="Day {{ i }}" {% if selected_day == 'Day ' ~ i %}selected{% endif %}>Day {{ i }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- Activity buttons and progress bar -->
    <div id="current-activity-details" class="text-center mt-4">No activity in progress</div>
    <div class="text-center mb-4">
        <button id="start-activity" class="btn btn-primary">Start/Restart Activity</button>
        <button id="stop-activity" class="btn btn-danger ms-2">Stop Activity</button>
    </div>
    <div id="countdown" class="mt-3 text-center"></div>
    <div id="activity-progress-bar" class="mt-2"></div>

    <!-- Cards for current and upcoming activities -->
    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">Current Activity</div>
                <div class="card-body">
                    <h5 class="card-title text-center" id="current-activity-name">No activity in progress</h5>
                    <p class="card-text text-center" id="current-activity-time"></p>
                </div>
            </div>
        </div>
        <div class="col-md-6 offset-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Upcoming Activity</div>
                <div class="card-body">
                    <h5 class="card-title text-center" id="upcoming-activity-name">No upcoming activity</h5>
                    <p class="card-text text-center" id="upcoming-activity-time"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Table overview for all activities of the selected day -->
    <div class="card">
        <div class="card-header">
            <h4>Activity Overview for {{ selected_day }}</h4>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th class="text-center align-middle">Activity</th>
                        <th class="text-center align-middle">Start Time</th>
                        <th class="text-center align-middle">End Time</th>
                        <th class="text-center align-middle">Duration</th>
                        <th class="text-center align-middle">Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in grouped_activities.get(selected_day, []) %}
                        <tr>
                            <td class="text-center align-middle">{{ activity[1] }}</td>
                            <td class="text-center align-middle">{{ activity[4] }}</td>
                            <td class="text-center align-middle">{{ activity[5] }}</td>
                            <td class="text-center align-middle">{{ activity[2] }} min</td>
                            <td class="text-center align-middle">
                                {% set status = 'pending' %}
                                {% for user_status in user_statuses %}
                                    {% if user_status[0] == activity[0] %}
                                        {% set status = user_status[1] %}
                                    {% endif %}
                                {% endfor %}
                                {{ status }}
                            </td>
                            <td>{{ activity[3].replace('\n', '<br>')|safe }}</td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center">No activities scheduled for {{ selected_day }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- JavaScript for handling activity buttons and progress bar -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/countdown.js') }}"></script>
    <script>
        function updateActivityBoxes(data) {
            if (data.current_activity) {
                document.getElementById("countdown").setAttribute("data-activity-id", data.current_activity.id);
            } else {
                document.getElementById("countdown").removeAttribute("data-activity-id");
            }
            document.getElementById("current-activity-name").innerText = data.current_activity ? data.current_activity.name : "No activity in progress";
            document.getElementById("current-activity-time").innerText = data.current_activity ? `${data.current_activity.start_time} to ${data.current_activity.end_time}` : "";
            document.getElementById("upcoming-activity-name").innerText = data.upcoming_activity ? data.upcoming_activity.name : "No upcoming activity";
            document.getElementById("upcoming-activity-time").innerText = data.upcoming_activity ? `at ${data.upcoming_activity.start_time}` : "";
        }

        const handleActivityAction = (action, payload, callback) => {
            fetch(`/${action}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.ok ? response.json() : Promise.reject(`Error: ${response.status} - ${response.statusText}`))
            .then(callback)
            .catch(error => {
                alert(`Failed to ${action.replace('_', ' ')}. Please check the console for more details.`);
                console.error(`Error in ${action} request:`, error);
            });
        };

        ["start", "stop"].forEach(action => {
    document.getElementById(`${action}-activity`).addEventListener("click", () => {
        const selectedDay = document.getElementById("day").value;
        if (!selectedDay) {
            alert(`Please select a day before ${action}ping an activity.`);
            return;
        }
        let userId = sessionStorage.getItem("user_id");
        if (!userId) {
            userId = crypto.randomUUID();
            sessionStorage.setItem("user_id", userId);
        }
        const activityId = document.getElementById("countdown").getAttribute("data-activity-id");
        if (action === "stop" && !activityId) {
            alert("No activity is currently in progress to stop.");
            return;
        }
        const payload = action === "start" ? { day: selectedDay, user_id: userId, activity_id: activityId } : { activity_id: activityId, user_id: userId };
        handleActivityAction(`${action}_activity`, payload, (data) => {
            if (data.error) {
                alert(data.error);
            } else {
                updateActivityBoxes(data);
            }
        });
    });
});
                if (action === "stop") {
                    const stopButton = document.getElementById("stop-activity");
                    stopButton.addEventListener("click", () => {
                        const activityId = document.getElementById("countdown").getAttribute("data-activity-id");
                        if (!activityId) {
                            alert("No activity is currently in progress to stop.");
                            return;
                        }
                    });
                }
            document.getElementById(`${action}-activity`).addEventListener("click", () => {
                const selectedDay = document.getElementById("day").value;
                if (!selectedDay) {
                    alert(`Please select a day before ${action}ping an activity.`);
                    return;
                }
                let userId = sessionStorage.getItem("user_id");
                if (!userId) {
                    userId = crypto.randomUUID();
                    sessionStorage.setItem("user_id", userId);
                }
                if (!userId) {
                    alert("User ID not found. Please refresh the page.");
                    return;
                }
                const activityId = document.getElementById("countdown").getAttribute("data-activity-id");
                const payload = action === "start" ? { day: selectedDay, user_id: userId, activity_id: activityId } : { activity_id: activityId, user_id: userId };
                handleActivityAction(`${action}_activity`, payload, (data) => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        updateActivityBoxes(data);
                    }
                });
            });
        });
    </script>
</body>
</html>