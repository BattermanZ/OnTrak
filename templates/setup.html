{% extends "base.html" %}

{% block title %}OnTrak Setup{% endblock %}

{% block content %}
<h1 class="mb-4">Create Training Template</h1>

<form id="template-form">
    <div class="mb-3">
        <label for="template-name" class="form-label">Template Name</label>
        <input type="text" class="form-control" id="template-name" name="name" required>
    </div>
    <div class="mb-3">
        <label for="template-description" class="form-label">Description</label>
        <textarea class="form-control" id="template-description" name="description" rows="3"></textarea>
    </div>
    <div class="mb-3">
        <label for="template-duration" class="form-label">Duration (days)</label>
        <input type="number" class="form-control" id="template-duration" name="duration" min="1" max="28" required>
    </div>

    <h2 class="mt-4 mb-3">Activities</h2>
    <div id="activities-container">
        <!-- Activities will be dynamically added here -->
    </div>
    <button type="button" class="btn btn-secondary mt-2" id="add-activity">Add Activity</button>

    <button type="submit" class="btn btn-primary mt-4">Create Template</button>
</form>

<template id="activity-template">
    <div class="card mb-3 activity-card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-2 mb-3">
                    <label class="form-label">Day</label>
                    <input type="number" class="form-control activity-day" name="activity-day" min="1" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Activity Name</label>
                    <input type="text" class="form-control activity-name" name="activity-name" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Start Time</label>
                    <input type="time" class="form-control activity-start-time" name="activity-start-time" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Duration (minutes)</label>
                    <input type="number" class="form-control activity-duration" name="activity-duration" min="1" required>
                </div>
                <div class="col-md-2 mb-3 d-flex align-items-end">
                    <button type="button" class="btn btn-danger remove-activity">Remove</button>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <label class="form-label">Description</label>
                    <textarea class="form-control activity-description" name="activity-description" rows="2"></textarea>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('template-form');
    const activitiesContainer = document.getElementById('activities-container');
    const addActivityButton = document.getElementById('add-activity');
    const activityTemplate = document.getElementById('activity-template');

    addActivityButton.addEventListener('click', function() {
        const newActivity = document.importNode(activityTemplate.content, true);
        activitiesContainer.appendChild(newActivity);
    });

    activitiesContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-activity')) {
            e.target.closest('.activity-card').remove();
        }
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const activities = [];

        document.querySelectorAll('.activity-card').forEach(function(card) {
            const activity = {
                day: card.querySelector('.activity-day').value,
                name: card.querySelector('.activity-name').value,
                description: card.querySelector('.activity-description').value,
                start_time: card.querySelector('.activity-start-time').value,
                duration: card.querySelector('.activity-duration').value
            };
            activities.push(Object.values(activity).join(','));
        });

        formData.append('activity', activities);

        fetch('/setup', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Template created successfully!');
                form.reset();
                activitiesContainer.innerHTML = '';
            } else {
                alert('Failed to create template.');
            }
        });
    });
});
</script>
{% endblock %}